{% extends 'tienda/base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    /* Leaflet fix for Bootstrap img max-width */
    .leaflet-pane img, 
    .leaflet-tile, 
    .leaflet-marker-icon, 
    .leaflet-marker-shadow {
        max-width: none !important;
        max-height: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card border-0 shadow-lg">
            <div class="card-body p-4 p-lg-5">
                <h2 class="text-center text-warning mb-4 fw-bold">
                    <i class="bi bi-pencil-square me-2"></i>Editar Producto
                </h2>

                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Categoría -->
                    <div class="mb-3">
                        <label for="{{ form.categoria.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-tag me-1"></i> Categoría
                        </label>
                        {{ form.categoria }}
                        {% if form.categoria.errors %}
                        <div class="text-danger small mt-1">{{ form.categoria.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Nombre del producto -->
                    <div class="mb-3">
                        <label for="{{ form.nombre.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-pencil-square me-1"></i> Nombre del producto
                        </label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}
                        <div class="text-danger small mt-1">{{ form.nombre.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Descripción -->
                    <div class="mb-3">
                        <label for="{{ form.descripcion.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-card-text me-1"></i> Descripción
                        </label>
                        {{ form.descripcion }}
                        {% if form.descripcion.errors %}
                        <div class="text-danger small mt-1">{{ form.descripcion.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Precio -->
                    <div class="mb-3">
                        <label for="{{ form.precio.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-currency-dollar me-1"></i> Precio
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.precio }}
                        </div>
                        {% if form.precio.errors %}
                        <div class="text-danger small mt-1">{{ form.precio.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Stock -->
                    <div class="mb-3">
                        <label for="{{ form.stock.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-box me-1"></i> Stock disponible
                        </label>
                        {{ form.stock }}
                        {% if form.stock.errors %}
                        <div class="text-danger small mt-1">{{ form.stock.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Ubicación -->
                    <div class="mb-3">
                        <label for="{{ form.ubicacion.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-geo-alt me-1"></i> Ubicación
                        </label>
                        {{ form.ubicacion }}
                        {% if form.ubicacion.errors %}
                        <div class="text-danger small mt-1">{{ form.ubicacion.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Mapa -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Ubicación exacta</label>
                        <div id="map-edit" style="height: 250px; width: 100%; border-radius: 0.5rem; overflow: hidden; z-index: 1;"></div>
                        <small class="text-muted mt-1 d-block">Haz clic en el mapa para actualizar la ubicación</small>
                        {{ form.latitud }}
                        {{ form.longitud }}
                    </div>

                    <!-- Imagen -->
                    <div class="mb-4">
                        <label for="{{ form.imagen.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-image me-1"></i> Imagen del producto
                        </label>
                        
                        {% if producto.imagen %}
                        <div class="mb-2">
                            <p class="small text-muted mb-1">Imagen actual:</p>
                            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" 
                                 class="rounded border shadow-sm" style="max-width: 150px; max-height: 150px; object-fit: contain;">
                        </div>
                        {% endif %}
                        
                        <div class="d-flex align-items-center gap-3">
                            <div class="flex-grow-1">
                                {{ form.imagen }}
                                <small class="text-muted d-block mt-1">Dejá vacío si no querés cambiar la imagen</small>
                                {% if form.imagen.errors %}
                                <div class="text-danger small mt-1">{{ form.imagen.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div id="preview-container" class="d-none rounded overflow-hidden border shadow-sm"
                                style="width: 80px; height: 80px;">
                                <img id="preview-image" src="#" alt="Vista previa" class="w-100 h-100 object-fit-cover">
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex gap-3 pt-2">
                        <a href="{% url 'tienda:detalle_producto' producto.id %}"
                            class="btn btn-outline-secondary flex-grow-1 py-2 fw-bold">
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-warning flex-grow-1 py-2 fw-bold shadow-sm text-white">
                            <i class="bi bi-check-lg me-2"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos para los campos generados por Django */
    input[type="text"],
    input[type="number"],
    textarea,
    select,
    input[type="file"] {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        outline: none;
    }

    textarea {
        min-height: 100px;
        resize: vertical;
    }

    select {
        cursor: pointer;
        background-color: white;
    }

    input[type="file"] {
        padding: 0.5rem;
        cursor: pointer;
    }

    .object-fit-cover {
        object-fit: cover;
    }

    /* Dark mode ajustes */
    [data-bs-theme="dark"] input[type="text"],
    [data-bs-theme="dark"] input[type="number"],
    [data-bs-theme="dark"] textarea,
    [data-bs-theme="dark"] select {
        background-color: #2c3034;
        border-color: #495057;
        color: #f8f9fa;
    }

    [data-bs-theme="dark"] .input-group-text {
        background-color: #2c3034;
        border-color: #495057;
        color: #f8f9fa;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Vista previa de imagen
        const imageInput = document.getElementById('{{ form.imagen.id_for_label }}');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');

        if (imageInput) {
            imageInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewContainer.classList.remove('d-none');
                    }
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.add('d-none');
                }
            });
        }

        // Leaflet Initialization
        if (typeof L !== 'undefined' && document.getElementById('map-edit')) {
            const latInput = document.getElementById('{{ form.latitud.id_for_label }}');
            const lonInput = document.getElementById('{{ form.longitud.id_for_label }}');
            
            // Default to Argentina center if no coords
            let initialLat = -34.6037;
            let initialLon = -58.3816;
            let zoom = 12;

            // Check if we have saved coordinates
            let hasSavedCoords = false;
            if (latInput && latInput.value && lonInput && lonInput.value) {
                const lat = parseFloat(latInput.value.replace(',', '.'));
                const lon = parseFloat(lonInput.value.replace(',', '.'));
                if (!isNaN(lat) && !isNaN(lon)) {
                    initialLat = lat;
                    initialLon = lon;
                    zoom = 15;
                    hasSavedCoords = true;
                }
            }

            var map = L.map('map-edit').setView([initialLat, initialLon], zoom);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var marker;
            if (hasSavedCoords) {
                marker = L.marker([initialLat, initialLon]).addTo(map);
            }

            map.on('click', function(e) {
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker(e.latlng).addTo(map);
                if (latInput) latInput.value = e.latlng.lat;
                if (lonInput) lonInput.value = e.latlng.lng;
            });
            
            // Sync with Nominatim on blur
            const ubicacionInput = document.getElementById('{{ form.ubicacion.id_for_label }}');
            if (ubicacionInput) {
                ubicacionInput.addEventListener('blur', function() {
                    const query = this.value;
                    if (query.length > 3) {
                         fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.length > 0) {
                                    const lat = parseFloat(data[0].lat);
                                    const lon = parseFloat(data[0].lon);
                                    map.setView([lat, lon], 14);
                                    
                                    // If no marker yet, add one
                                    if (!marker) {
                                        marker = L.marker([lat, lon]).addTo(map);
                                        if (latInput) latInput.value = lat;
                                        if (lonInput) lonInput.value = lon;
                                    }
                                }
                            })
                            .catch(err => console.error("Nominatim error:", err));
                    }
                });
            }
            
            // Force map resize check to prevent gray areas
            setTimeout(() => {
                map.invalidateSize();
            }, 500);
        }
    });
</script>
{% endblock %}

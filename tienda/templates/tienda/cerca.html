{% extends 'tienda/base.html' %}
{% block title %}Cerca tuyo - LinkOeste{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  #map { height: 380px; border-radius: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--card-border); }
</style>
{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="fw-bold mb-3">Productos cerca tuyo</h2>
  <div class="row g-3 mb-3">
    <div class="col-md-6 d-flex align-items-center gap-2">
      <button class="btn btn-success" id="btn-geo">Usar mi ubicación</button>
      <select id="radius" class="form-select" style="max-width:160px">
        <option value="3">3 km</option>
        <option value="5" selected>5 km</option>
        <option value="10">10 km</option>
        <option value="20">20 km</option>
      </select>
      <select id="categoria" class="form-select" style="max-width:220px">
        <option value="">Todas</option>
        {% for value, label in categorias %}
        <option value="{{ label }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6 d-flex align-items-center gap-2">
      <input type="text" id="buscar" class="form-control" placeholder="Buscar dirección o lugar">
      <button class="btn btn-outline-primary" id="btn-geocode"><i class="bi bi-geo-alt"></i></button>
    </div>
  </div>
  <div id="map" class="mb-3"></div>
  <div id="status" class="text-muted mb-2"></div>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-4" id="grid"></div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map, userMarker, markersLayer;
  function distanceKm(a, b) {
    const R = 6371;
    const dLat = (b.lat - a.lat) * Math.PI / 180;
    const dLon = (b.lon - a.lon) * Math.PI / 180;
    const lat1 = a.lat * Math.PI / 180;
    const lat2 = b.lat * Math.PI / 180;
    const s = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
  }
  function initMap() {
    if (map) return;
    map = L.map('map').setView([-34.6037, -58.3816], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }
  function card(p) {
    const price = new Intl.NumberFormat('es-AR').format(p.precio);
    const img = p.imagen ? `<img src="${p.imagen}" alt="${p.nombre}" class="w-100 h-100" loading="lazy">` :
      `<div class="w-100 h-100 d-flex align-items-center justify-content-center"><i class="bi bi-card-image display-1 text-secondary opacity-25"></i></div>`;
    const dist = typeof p.distancia_km === 'number' ? `<small class="text-muted mt-1">A ${p.distancia_km} km</small>` : '';
    return `
    <div class="col">
      <div class="card product-card h-100 border-0 shadow-sm position-relative">
        <a href="/productos/${p.id}/" class="text-decoration-none">
          <div class="card-img-top product-image bg-light position-relative overflow-hidden">${img}</div>
        </a>
        <div class="card-body p-3 d-flex flex-column">
          <a href="/productos/${p.id}/" class="text-decoration-none text-dark">
            <div class="product-title text-truncate" title="${p.nombre}">${p.nombre}</div>
          </a>
          <div class="product-price">$${price}</div>
          <div class="mt-1"><span class="badge-shipping">${p.categoria}</span></div>
          ${dist}
          <div class="product-actions d-flex gap-2 mt-auto">
            <a href="/productos/${p.id}/" class="btn btn-outline-primary"><i class="bi bi-eye"></i></a>
          </div>
        </div>
      </div>
    </div>`;
  }
  function cargar(lat, lon, radius) {
    const grid = document.getElementById('grid');
    const status = document.getElementById('status');
    status.textContent = 'Buscando productos cerca...';
    fetch(`/cerca/api/?lat=${lat}&lon=${lon}&radius=${radius}`, { credentials: 'same-origin' })
      .then(r => r.json())
      .then(data => {
        let items = data.products || [];
        const categoria = document.getElementById('categoria').value || '';
        if (categoria) items = items.filter(i => i.categoria === categoria);
        grid.innerHTML = items.map(card).join('');
        if (markersLayer) markersLayer.clearLayers();
        items.forEach(p => {
          if (typeof p.latitud === 'number' && typeof p.longitud === 'number') {
            const m = L.marker([p.latitud, p.longitud]).bindPopup(`<strong>${p.nombre}</strong><br><a href="/productos/${p.id}/">Ver detalle</a>`);
            markersLayer.addLayer(m);
          }
        });
        status.textContent = items.length ? `Encontrados ${items.length} productos` : 'No hay productos cerca';
      })
      .catch(() => { status.textContent = 'Error al buscar cercanos'; });
  }
  document.getElementById('btn-geo').addEventListener('click', () => {
    const status = document.getElementById('status');
    status.textContent = 'Obteniendo ubicación...';
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const radius = document.getElementById('radius').value;
        localStorage.setItem('user_lat', String(lat));
        localStorage.setItem('user_lon', String(lon));
        initMap();
        if (userMarker) { userMarker.setLatLng([lat, lon]); } else { userMarker = L.marker([lat, lon], { icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [25, 41], iconAnchor: [12, 41] }) }).addTo(map); }
        map.setView([lat, lon], 13);
        cargar(lat, lon, radius);
      },
      err => { status.textContent = 'No se pudo obtener tu ubicación'; },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  });
  document.getElementById('btn-geocode').addEventListener('click', () => {
    const q = document.getElementById('buscar').value.trim();
    if (!q) return;
    const status = document.getElementById('status');
    status.textContent = 'Buscando lugar...';
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`)
      .then(r => r.json())
      .then(res => {
        if (!res.length) { status.textContent = 'No se encontró la dirección'; return; }
        const lat = parseFloat(res[0].lat);
        const lon = parseFloat(res[0].lon);
        localStorage.setItem('user_lat', String(lat));
        localStorage.setItem('user_lon', String(lon));
        initMap();
        if (userMarker) { userMarker.setLatLng([lat, lon]); } else { userMarker = L.marker([lat, lon]).addTo(map); }
        map.setView([lat, lon], 13);
        const radius = document.getElementById('radius').value;
        cargar(lat, lon, radius);
        status.textContent = 'Resultados actualizados';
      })
      .catch(() => { status.textContent = 'Error de geocodificación'; });
  });
  document.getElementById('radius').addEventListener('change', () => {
    const lat = parseFloat(localStorage.getItem('user_lat') || 'NaN');
    const lon = parseFloat(localStorage.getItem('user_lon') || 'NaN');
    if (!isNaN(lat) && !isNaN(lon)) cargar(lat, lon, document.getElementById('radius').value);
  });
  document.getElementById('categoria').addEventListener('change', () => {
    const lat = parseFloat(localStorage.getItem('user_lat') || 'NaN');
    const lon = parseFloat(localStorage.getItem('user_lon') || 'NaN');
    if (!isNaN(lat) && !isNaN(lon)) cargar(lat, lon, document.getElementById('radius').value);
  });
  initMap();
</script>
{% endblock %}

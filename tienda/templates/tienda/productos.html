{% extends 'tienda/base.html' %}
{% load static %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0;">
    <h2 style="margin:0;">ğŸ›ï¸ Productos disponibles</h2>
    {% if user.is_authenticated %}
    <a href="{% url 'tienda:agregar_producto' %}" 
       style="background:#16a34a; color:white; padding:10px 20px; border-radius:8px; text-decoration:none; font-weight:600; display:inline-flex; align-items:center; gap:8px; transition:all 0.3s ease;">
        <span style="font-size:1.2em;">â•</span>
        Agregar producto
    </a>
    {% endif %}
</div>

<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:20px;">
  {% for producto in productos %}
  <div style="border:1px solid #ddd; border-radius:10px; width:220px; text-align:center; padding:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 4px 15px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
    <a href="{% url 'tienda:detalle_producto' producto.id %}" style="text-decoration: none; color: inherit;">
      {% if producto.imagen %}
        <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" style="width:100%; height:180px; object-fit:cover; border-radius:10px; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
      {% else %}
        <img src="{% static 'img/no-image.png' %}" alt="Sin imagen" style="width:100%; height:180px; object-fit:cover; border-radius:10px;">
      {% endif %}
      <h3 style="margin-top:10px;">{{ producto.nombre }}</h3>
      <p style="color:#666; font-size:0.9rem; margin:8px 0; height:60px; overflow-y:auto; text-align:left; padding:0 5px;">
        {{ producto.descripcion|default:"Sin descripciÃ³n"|truncatechars:120 }}
      </p>
      <p style="font-weight:bold; color:#28a745;">${{ producto.precio }}</p>
    </a>
    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
      <button class="btn-agregar" 
              data-id="{{ producto.id }}"
              style="background:#28a745; color:white; border:none; border-radius:8px; padding:8px 15px; cursor:pointer; transition:0.3s;">
        ğŸ›’ Agregar al carrito
      </button>

      {% if user.is_authenticated and producto.usuario == user %}
        <form method="post" action="{% url 'tienda:eliminar_producto' producto.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" style="background:#ef4444; color:white; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">
            ğŸ—‘ Eliminar
          </button>
        </form>
      {% endif %}
    </div>
  </div>
  {% empty %}
  <p style="text-align:center;">No hay productos disponibles.</p>
  {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const botones = document.querySelectorAll(".btn-agregar");

  botones.forEach(boton => {
    boton.addEventListener("click", () => {
      const productoId = boton.dataset.id;

      // PeticiÃ³n AJAX
      fetch(`/carrito/agregar/${productoId}/`, {
        method: "GET",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Actualiza el contador de carrito en el header
          const contador = document.getElementById("contador-carrito");
          if (contador) contador.textContent = data.total_items;

          // AnimaciÃ³n o aviso visual
          boton.textContent = "âœ… Agregado";
          boton.style.background = "#007bff";
          setTimeout(() => {
            boton.textContent = "ğŸ›’ Agregar al carrito";
            boton.style.background = "#28a745";
          }, 1200);
        } else {
          alert("No se pudo agregar al carrito ğŸ˜¢");
        }
      })
      .catch(err => console.error("Error al agregar al carrito:", err));
    });
  });
});
</script>
{% endblock %}

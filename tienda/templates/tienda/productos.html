{% extends 'tienda/base.html' %}
{% load humanize %}

{% block content %}
<div class="container py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold">Todos los Productos</h2>
    </div>
  </div>

  <!-- Filtros y Ordenamiento -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3" id="productos-form">
        <!-- Búsqueda -->
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0" name="q" placeholder="Buscar productos..."
              value="{{ query|default:'' }}">
          </div>
        </div>

        <!-- Categoría -->
        <div class="col-md-3">
          <select class="form-select" name="categoria">
            <option value="">Todas las categorías</option>
            {% for value, label in categorias %}
            <option value="{{ value }}" {% if categoria == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Precio mínimo -->
        <div class="col-md-2">
          <input type="number" class="form-control" name="precio_min" placeholder="Precio mín." value="{{ precio_min }}"
            step="0.01">
        </div>

        <!-- Precio máximo -->
        <div class="col-md-2">
          <input type="number" class="form-control" name="precio_max" placeholder="Precio máx." value="{{ precio_max }}"
            step="0.01">
        </div>

        <!-- Ordenar -->
        <div class="col-md-3">
          <select class="form-select" name="orden">
            <option value="recientes" {% if orden == 'recientes' or not orden %}selected{% endif %}>Más recientes</option>
            <option value="antiguos" {% if orden == 'antiguos' %}selected{% endif %}>Más antiguos</option>
            <option value="precio_asc" {% if orden == 'precio_asc' %}selected{% endif %}>Menor precio</option>
            <option value="precio_desc" {% if orden == 'precio_desc' %}selected{% endif %}>Mayor precio</option>
            <option value="nombre" {% if orden == 'nombre' %}selected{% endif %}>Nombre A-Z</option>
          </select>
        </div>

        <div class="col-md-1">
          <button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel-fill"></i></button>
        </div>
      </form>
    </div>
  </div>

  <!-- Grid de Productos (llenado vía API) -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-4" id="productos-grid"></div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const form = document.getElementById('productos-form');
    const grid = document.getElementById('productos-grid');
    if (!form || !grid) return;
    let page = 1;
    let hasNext = true;
    let loading = false;
    const pageSize = 12;
    const state = {
      q: form.querySelector('[name="q"]')?.value || '',
      categoria: form.querySelector('[name="categoria"]')?.value || '',
      precio_min: form.querySelector('[name="precio_min"]')?.value || '',
      precio_max: form.querySelector('[name="precio_max"]')?.value || '',
      orden: form.querySelector('[name="orden"]')?.value || 'recientes',
    };
    function getUserCoords() {
      const lat = parseFloat(localStorage.getItem('user_lat') || 'NaN');
      const lon = parseFloat(localStorage.getItem('user_lon') || 'NaN');
      if (isNaN(lat) || isNaN(lon)) return null;
      return { lat, lon };
    }
    function distanceKm(a, b) {
      const R = 6371;
      const dLat = (b.lat - a.lat) * Math.PI / 180;
      const dLon = (b.lon - a.lon) * Math.PI / 180;
      const lat1 = a.lat * Math.PI / 180;
      const lat2 = b.lat * Math.PI / 180;
      const s = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
    }
    function starIcons(avg) {
      if (!avg && avg !== 0) return '';
      let html = '';
      for (let i = 1; i <= 5; i++) {
        if (i <= avg) {
          html += '<i class="bi bi-star-fill text-warning"></i>';
        } else if (i - 1 < avg) {
          html += '<i class="bi bi-star-half text-warning"></i>';
        } else {
          html += '<i class="bi bi-star text-warning"></i>';
        }
      }
      return html;
    }
    function productCard(p) {
      const img = p.imagen ? `<img src="${p.imagen}" alt="${p.nombre}" class="w-100 h-100" loading="lazy">` :
        `<div class="w-100 h-100 d-flex align-items-center justify-content-center"><i class="bi bi-card-image display-1 text-secondary opacity-25"></i></div>`;
      const price = new Intl.NumberFormat('es-AR').format(p.precio);
      const badgeVerificado = p.email_verificado ? `<span class="badge bg-success ms-1" style="font-size:0.65rem;"><i class="bi bi-shield-check"></i></span>` : '';
      const rating = p.promedio_calificacion ? `<div class="product-rating mt-1" style="font-size: 0.7rem;">${starIcons(p.promedio_calificacion)}</div>` : '';
      const acciones = p.stock <= 0
        ? `<button type="button" class="btn btn-secondary flex-grow-1" disabled><i class="bi bi-exclamation-circle"></i> Sin stock</button>`
        : `<button type="button" class="btn btn-success btn-agregar flex-grow-1" data-id="${p.id}"><i class="bi bi-cart-plus"></i> Agregar</button>`;
      let distancia = '';
      const coords = getUserCoords();
      if (coords && typeof p.latitud === 'number' && typeof p.longitud === 'number') {
        const d = distanceKm(coords, { lat: p.latitud, lon: p.longitud });
        if (!isNaN(d)) distancia = `<small class="text-muted mt-1">A ${d.toFixed(2)} km</small>`;
      }
      return `
      <div class="col">
        <div class="card product-card h-100 border-0 shadow-sm position-relative">
          <a href="/productos/${p.id}/" class="text-decoration-none">
            <div class="card-img-top product-image bg-light position-relative overflow-hidden">
              ${img}
            </div>
          </a>
          <div class="card-body p-3 d-flex flex-column">
            <a href="/productos/${p.id}/" class="text-decoration-none text-dark">
              <div class="product-title text-truncate" title="${p.nombre}">${p.nombre} ${badgeVerificado}</div>
            </a>
            <div class="product-price">$${price}</div>
            <div class="mt-1"><span class="badge-shipping">${p.categoria}</span></div>
            ${distancia}
            ${rating}
            <div class="product-actions d-flex gap-2 mt-auto">
              ${acciones}
            </div>
          </div>
        </div>
      </div>`;
    }
    function qs() {
      const params = new URLSearchParams();
      if (state.q) params.set('q', state.q);
      if (state.categoria) params.set('categoria', state.categoria);
      if (state.precio_min) params.set('precio_min', state.precio_min);
      if (state.precio_max) params.set('precio_max', state.precio_max);
      if (state.orden) params.set('orden', state.orden);
      params.set('page', String(page));
      params.set('page_size', String(pageSize));
      return params.toString();
    }
    function load(reset = false) {
      if (loading || (!hasNext && !reset)) return;
      loading = true;
      if (reset) {
        page = 1;
        hasNext = true;
        grid.innerHTML = '';
      }
      fetch(`/productos/api/?${qs()}`, { credentials: 'same-origin' })
        .then(r => r.json())
        .then(data => {
          const items = data.products || [];
          const html = items.map(productCard).join('');
          grid.insertAdjacentHTML('beforeend', html);
          hasNext = Boolean(data.has_next);
          page = (data.page || page) + 1;
        })
        .finally(() => { loading = false; });
    }
    let t;
    function debounce(fn, wait) {
      return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }
    const onChange = debounce(() => {
      state.q = form.querySelector('[name="q"]')?.value || '';
      state.categoria = form.querySelector('[name="categoria"]')?.value || '';
      state.precio_min = form.querySelector('[name="precio_min"]')?.value || '';
      state.precio_max = form.querySelector('[name="precio_max"]')?.value || '';
      state.orden = form.querySelector('[name="orden"]')?.value || 'recientes';
      load(true);
    }, 250);
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      onChange();
    });
    ['q', 'categoria', 'precio_min', 'precio_max', 'orden'].forEach(name => {
      const el = form.querySelector(`[name="${name}"]`);
      if (!el) return;
      const ev = name === 'q' ? 'input' : 'change';
      el.addEventListener(ev, onChange);
    });
    window.addEventListener('scroll', function () {
      if (!hasNext) return;
      const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 200;
      if (nearBottom) load(false);
    });
    load(true);
  })();
</script>
{% endblock %}

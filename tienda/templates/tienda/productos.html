{% extends 'tienda/base.html' %}
{% load humanize %}

{% block content %}
<div class="container py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold">Todos los Productos</h2>
    </div>
  </div>

  <!-- Filtros y Ordenamiento -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3">
        <!-- Búsqueda -->
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0" name="q" placeholder="Buscar productos..."
              value="{{ query|default:'' }}">
          </div>
        </div>

        <!-- Categoría -->
        <div class="col-md-3">
          <select class="form-select" name="categoria">
            <option value="">Todas las categorías</option>
            {% for value, label in categorias %}
            <option value="{{ value }}" {% if categoria==value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Precio mínimo -->
        <div class="col-md-2">
          <input type="number" class="form-control" name="precio_min" placeholder="Precio mín." value="{{ precio_min }}"
            step="0.01">
        </div>

        <!-- Precio máximo -->
        <div class="col-md-2">
          <input type="number" class="form-control" name="precio_max" placeholder="Precio máx." value="{{ precio_max }}"
            step="0.01">
        </div>

        <!-- Ordenar -->
        <div class="col-md-3">
          <select class="form-select" name="orden">
            <option value="recientes" {% if orden=='recientes' or not orden %}selected{% endif %}>Más recientes</option>
            <option value="antiguos" {% if orden=='antiguos' %}selected{% endif %}>Más antiguos</option>
            <option value="precio_asc" {% if orden=='precio_asc' %}selected{% endif %}>Menor precio</option>
            <option value="precio_desc" {% if orden=='precio_desc' %}selected{% endif %}>Mayor precio</option>
            <option value="nombre" {% if orden=='nombre' %}selected{% endif %}>Nombre A-Z</option>
          </select>
        </div>

        <div class="col-md-1">
          <button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel-fill"></i></button>
        </div>
      </form>
    </div>
  </div>

  <!-- Grid de Productos -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-4">
    {% for producto in productos %}
    <div class="col">
      <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
        <a href="{% url 'tienda:detalle_producto' producto.id %}" class="text-decoration-none">
          <div class="card-img-top bg-light position-relative overflow-hidden" style="height: 250px !important;">
            {% if producto.imagen %}
            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="w-100 h-100"
              style="object-fit: cover;">
            {% else %}
            <div class="w-100 h-100 d-flex align-items-center justify-content-center">
              <i class="bi bi-card-image display-1 text-secondary opacity-25"></i>
            </div>
            {% endif %}
          </div>
        </a>

        <!-- Botón de favorito -->
        {% if user.is_authenticated %}
        <button class="btn btn-link position-absolute top-0 end-0 m-2 btn-favorito shadow-sm"
          data-producto-id="{{ producto.id }}"
          style="background: rgba(255,255,255,0.9); border-radius: 50%; width: 35px; height: 35px; padding: 0; display: flex; align-items: center; justify-content: center;">
          {% if producto.es_favorito %}
          <i class="bi bi-heart-fill text-danger"></i>
          {% else %}
          <i class="bi bi-heart text-danger"></i>
          {% endif %}
        </button>
        {% endif %}
      </div>

      <!-- Cuerpo -->
      <div class="card-body d-flex flex-column p-3">
        <div class="d-flex justify-content-between align-items-start mb-1">
          <h5 class="text-success fw-bold mb-0">${{ producto.precio|intcomma }}</h5>
          {% if producto.ubicacion %}
          <small class="text-muted text-truncate" style="max-width: 100px;" title="{{ producto.ubicacion }}">
            <i class="bi bi-geo-alt-fill me-1"></i>{{ producto.ubicacion }}
          </small>
          {% endif %}
        </div>

        <div class="mb-1">
          <span class="badge bg-info bg-opacity-10 text-info rounded-pill" style="font-size: 0.7rem;">{{
            producto.get_categoria_display }}</span>
        </div>

        <a href="{% url 'tienda:detalle_producto' producto.id %}" class="text-decoration-none text-dark">
          <h6 class="card-title fw-bold mb-2 text-truncate" title="{{ producto.nombre }}">{{ producto.nombre }}</h6>
        </a>

        <!-- Calificación -->
        {% if producto.promedio_calificacion %}
        <div class="mb-2">
          {% with promedio=producto.promedio_calificacion %}
          {% for i in "12345" %}
          {% if forloop.counter <= promedio %} <i class="bi bi-star-fill text-warning small" style="font-size: 0.7rem;">
            </i>
            {% elif forloop.counter|add:"-1" < promedio %} <i class="bi bi-star-half text-warning small"
              style="font-size: 0.7rem;"></i>
              {% else %}
              <i class="bi bi-star text-warning small" style="font-size: 0.7rem;"></i>
              {% endif %}
              {% endfor %}
              {% endwith %}
        </div>
        {% endif %}

        <p class="card-text text-muted small flex-grow-1 mb-3" style="font-size: 0.85rem;">{{
          producto.descripcion|default:"Sin descripción"|truncatechars:60 }}</p>

        <!-- Botones -->
        <div class="d-flex gap-2 mt-auto">
          <button class="btn btn-success flex-grow-1 btn-agregar" data-id="{{ producto.id }}">
            <i class="bi bi-cart-plus"></i> Agregar
          </button>

          {% if user.is_authenticated %}
          {% if user != producto.usuario %}
          <button class="btn btn-outline-primary btn-chat-vendedor" data-vendedor-id="{{ producto.usuario.id }}"
            data-vendedor-nombre="{{ producto.usuario.username }}">
            <i class="bi bi-chat-dots"></i>
          </button>
          {% endif %}
          {% else %}
          <a href="{% url 'tienda:register' %}" class="btn btn-primary flex-grow-1" title="Registrate para comprar">
            <i class="bi bi-lock-fill"></i>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12 text-center py-5">
      <p class="text-muted fs-5">No se encontraron productos.</p>
    </div>
    {% endfor %}
  </div>

  <!-- Paginación -->
  {% if is_paginated %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
          href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.precio_min %}&precio_min={{ request.GET.precio_min }}{% endif %}{% if request.GET.precio_max %}&precio_max={{ request.GET.precio_max }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}">Anterior</a>
      </li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
      <li class="page-item {% if page_obj.number == num %}active{% endif %}">
        <a class="page-link"
          href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.precio_min %}&precio_min={{ request.GET.precio_min }}{% endif %}{% if request.GET.precio_max %}&precio_max={{ request.GET.precio_max }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}">{{
          num }}</a>
      </li>
      {% endfor %}

      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
          href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.precio_min %}&precio_min={{ request.GET.precio_min }}{% endif %}{% if request.GET.precio_max %}&precio_max={{ request.GET.precio_max }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}">Siguiente</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- Modal Chat -->
<div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chat con <span id="chatVendedorNombre"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="chatForm">
          {% csrf_token %}
          <input type="hidden" id="vendedorId" name="destinatario_id">
          <div class="mb-3">
            <textarea class="form-control" id="mensajeContent" rows="3" placeholder="Escribe tu mensaje..."
              required></textarea>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Enviar Mensaje</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Script para agregar al carrito
  document.querySelectorAll('.btn-agregar').forEach(btn => {
    btn.addEventListener('click', function () {
      const productoId = this.dataset.id;
      fetch(`/tienda/agregar-al-carrito/${productoId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Actualizar contador del carrito si existe
            const cartBadge = document.querySelector('.badge.bg-danger');
            if (cartBadge) {
              cartBadge.textContent = data.cart_total;
            }

            // Mostrar toast o alerta
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '11';
            toast.innerHTML = `
                        <div class="toast show align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">
                                    Producto agregado al carrito
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
          }
        });
    });
  });

  // Script para favoritos
  document.querySelectorAll('.btn-favorito').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      const productoId = this.dataset.productoId;
      const icon = this.querySelector('i');

      fetch(`/tienda/toggle-favorito/${productoId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'added') {
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill');
          } else {
            icon.classList.remove('bi-heart-fill');
            icon.classList.add('bi-heart');
          }
        });
    });
  });

  // Script para chat
  const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
  document.querySelectorAll('.btn-chat-vendedor').forEach(btn => {
    btn.addEventListener('click', function () {
      document.getElementById('vendedorId').value = this.dataset.vendedorId;
      document.getElementById('chatVendedorNombre').textContent = this.dataset.vendedorNombre;
      chatModal.show();
    });
  });

  document.getElementById('chatForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const destinatarioId = document.getElementById('vendedorId').value;
    const contenido = document.getElementById('mensajeContent').value;

    fetch('/tienda/enviar-mensaje/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `destinatario_id=${destinatarioId}&contenido=${encodeURIComponent(contenido)}`
    })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          chatModal.hide();
          document.getElementById('mensajeContent').value = '';
          alert('Mensaje enviado correctamente');
        }
      });
  });
</script>
{% endblock %}
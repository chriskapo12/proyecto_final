{% load static %}
<!DOCTYPE html>
<html lang="es" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Tienda Online{% endblock %}</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary-color: #16a34a;
            --primary-hover: #15803d;
        }

        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Personalización de Bootstrap */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .text-primary {
            color: var(--primary-color) !important;
        }

        /* Navbar */
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
        }

        /* Carrito flotante */
        .carrito-btn {
            position: relative;
            font-size: 1.5rem;
            color: var(--primary-color);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .carrito-btn:hover {
            transform: scale(1.1);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -10px;
            font-size: 0.7rem;
        }

        /* Overlay Carrito */
        .offcanvas-end {
            width: 400px;
        }

        /* Chat Flotante */
        .chat-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            z-index: 1050;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-panel.activo {
            display: flex;
        }

        /* Dark Mode overrides */
        [data-bs-theme="dark"] .chat-panel {
            background-color: #212529;
            border: 1px solid #373b3e;
        }

        main {
            flex: 1;
        }

        /* Animaciones */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <!-- Navbar Bootstrap -->
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="{% url 'tienda:home' %}">
                <i class="bi bi-cup-straw"></i> Bebidas Oeste
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarContent">
                <!-- Buscador -->
                <form class="d-flex mx-auto my-2 my-lg-0" role="search" style="max-width: 400px; width: 100%;"
                    method="GET" action="{% url 'tienda:productos' %}">
                    <div class="input-group">
                        <input class="form-control" type="search" name="buscar" placeholder="Buscar productos..."
                            id="search-input" value="{{ buscar|default:'' }}">
                        <button class="btn btn-outline-success" type="submit" id="search-btn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </form>

                <ul class="navbar-nav ms-auto align-items-center gap-3">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'tienda:productos' %}">Productos</a>
                    </li>

                    <!-- Theme Toggle -->
                    <li class="nav-item">
                        <button class="btn btn-link nav-link" id="theme-toggle">
                            <i class="bi bi-moon-stars-fill"></i>
                        </button>
                    </li>

                    {% if user.is_authenticated %}
                    <!-- Chat -->
                    <li class="nav-item">
                        <div class="carrito-btn" id="abrir-chat" title="Mensajes">
                            <i class="bi bi-chat-dots"></i>
                            <span class="badge rounded-pill bg-danger badge-count" id="chat-badge"
                                style="display:none;">0</span>
                        </div>
                    </li>

                    <!-- Carrito -->
                    <li class="nav-item">
                        <div class="carrito-btn" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
                            <i class="bi bi-cart3"></i>
                            <span class="badge rounded-pill bg-danger badge-count" id="contador-carrito">
                                {{ user.carrito.total_items|default:0 }}
                            </span>
                        </div>
                    </li>

                    <!-- Perfil Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" role="button"
                            data-bs-toggle="dropdown">
                            {% if user.perfil.foto_perfil %}
                            <img src="{{ user.perfil.foto_perfil.url }}" class="rounded-circle" width="30" height="30"
                                style="object-fit: cover;">
                            {% else %}
                            <i class="bi bi-person-circle fs-4"></i>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'tienda:mi_perfil' %}"><i class="bi bi-person me-2"></i>Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="{% url 'tienda:mis_favoritos' %}"><i class="bi bi-heart me-2"></i>Mis Favoritos</a></li>
                            <li><a class="dropdown-item" href="{% url 'tienda:mis_pedidos' %}"><i class="bi bi-box-seam me-2"></i>Mis Pedidos</a></li>
                            <li><a class="dropdown-item" href="{% url 'tienda:agregar_producto' %}"><i class="bi bi-plus-circle me-2"></i>Vender Producto</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="{% url 'tienda:logout' %}"><i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión</a>
                            </li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a href="{% url 'tienda:login' %}" class="btn btn-outline-primary me-2">Ingresar</a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'tienda:register' %}" class="btn btn-primary">Registrarse</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="container py-4 fade-in">
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags|cut:'error'|default:'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-auto">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 <span class="text-success fw-bold">Bebidas Oeste</span>. Todos los derechos
                reservados.</p>
        </div>
    </footer>

    <!-- Offcanvas Carrito (Bootstrap) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito">
        <div class="offcanvas-header bg-light">
            <h5 class="offcanvas-title"><i class="bi bi-cart3"></i> Tu Carrito</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column">
            <div id="carrito-items" class="flex-grow-1 overflow-auto">
                <!-- Items inyectados por JS -->
            </div>

            <div class="border-top pt-3 mt-3">
                <div class="d-flex justify-content-between mb-3">
                    <span class="h5">Total:</span>
                    <span class="h5 text-success fw-bold" id="total-carrito">$0.00</span>
                </div>
                <a href="{% url 'tienda:procesar_pago' %}" id="btn-pagar" class="btn btn-success w-100 py-2 fw-bold">
                    <i class="bi bi-credit-card"></i> Pagar Ahora
                </a>
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chat-panel">
        <div class="d-flex justify-content-between align-items-center p-3 bg-success text-white">
            <h6 class="mb-0"><i class="bi bi-chat-dots"></i> Mensajes</h6>
            <button type="button" class="btn-close btn-close-white" id="cerrar-chat"></button>
        </div>

        <!-- Lista de conversaciones -->
        <div class="flex-grow-1 overflow-auto p-0" id="chat-list-view">
            <div class="list-group list-group-flush" id="chat-list">
                <!-- Conversaciones JS -->
            </div>
        </div>

        <!-- Vista Mensajes -->
        <div class="d-none flex-column h-100" id="chat-messages-view">
            <div class="p-2 bg-light border-bottom d-flex align-items-center">
                <button class="btn btn-sm btn-link text-decoration-none" id="volver-chat"><i
                        class="bi bi-arrow-left"></i></button>
                <span class="fw-bold ms-2" id="chat-user-name">Usuario</span>
            </div>
            <div class="flex-grow-1 overflow-auto p-3 d-flex flex-column gap-2" id="chat-messages">
                <!-- Mensajes JS -->
            </div>
            <div class="p-2 border-top d-flex gap-2">
                <input type="text" class="form-control form-control-sm" id="chat-input"
                    placeholder="Escribe un mensaje...">
                <button class="btn btn-sm btn-success" id="chat-send-btn"><i class="bi bi-send"></i></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Scripts Lógica -->
    <script>
        // Dark Mode Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;
        const icon = themeToggle.querySelector('i');

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-bs-theme', newTheme);
            icon.className = newTheme === 'light' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
            localStorage.setItem('theme', newTheme);
        });

        // Cargar tema guardado
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-bs-theme', savedTheme);
        if (savedTheme === 'dark') icon.className = 'bi bi-sun-fill';

        // Lógica del Carrito
        const offcanvasElement = document.getElementById('offcanvasCarrito');
        const offcanvasCarrito = new bootstrap.Offcanvas(offcanvasElement);

        offcanvasElement.addEventListener('show.bs.offcanvas', cargarCarrito);

        function cargarCarrito() {
            fetch("{% url 'tienda:obtener_carrito_ajax' %}")
                .then(res => res.json())
                .then(data => {
                    const contenedor = document.getElementById('carrito-items');
                    contenedor.innerHTML = '';

                    if (!data.items || data.items.length === 0) {
                        contenedor.innerHTML = '<div class="text-center text-muted mt-5"><i class="bi bi-cart-x display-4"></i><p class="mt-2">Carrito vacío</p></div>';
                        document.getElementById('btn-pagar').classList.add('disabled');
                    } else {
                        document.getElementById('btn-pagar').classList.remove('disabled');
                        data.items.forEach(item => {
                            contenedor.innerHTML += `
                            <div class="card mb-2 border-0 shadow-sm">
                                <div class="card-body p-2 d-flex gap-2 align-items-center">
                                    <img src="${item.imagen || 'https://via.placeholder.com/50'}" class="rounded bg-light" width="50" height="50" style="object-fit:contain; padding: 2px;">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 text-truncate" style="max-width: 150px;">${item.nombre}</h6>
                                        <small class="text-muted">$${item.precio}</small>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="actualizarCantidad(${item.producto_id}, 'restar')">-</button>
                                        <span class="small fw-bold">${item.cantidad}</span>
                                        <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="actualizarCantidad(${item.producto_id}, 'sumar')">+</button>
                                    </div>
                                    <button class="btn btn-sm text-danger" onclick="eliminarDelCarrito(${item.producto_id})"><i class="bi bi-trash"></i></button>
                                </div>
                            </div>
                        `;
                        });
                    }
                    document.getElementById('total-carrito').textContent = `$${data.total.toFixed(2)}`;
                    document.getElementById('contador-carrito').textContent = data.total_items;
                });
        }

        function actualizarCantidad(id, accion) {
            fetch("{% url 'tienda:actualizar_cantidad' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ producto_id: id, accion: accion })
            }).then(() => cargarCarrito());
        }

        function eliminarDelCarrito(id) {
            fetch(`/carrito/eliminar/${id}/`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(() => cargarCarrito());
        }

        // Lógica del Chat (Simplificada para Bootstrap)
        const chatPanel = document.getElementById('chat-panel');
        const abrirChat = document.getElementById('abrir-chat');
        const cerrarChat = document.getElementById('cerrar-chat');
        const chatListView = document.getElementById('chat-list-view');
        const chatMessagesView = document.getElementById('chat-messages-view');
        const volverChat = document.getElementById('volver-chat');

        if (abrirChat) {
            abrirChat.addEventListener('click', () => {
                chatPanel.classList.toggle('activo');
                cargarConversaciones();
            });
        }

        if (cerrarChat) {
            cerrarChat.addEventListener('click', () => chatPanel.classList.remove('activo'));
        }

        if (volverChat) {
            volverChat.addEventListener('click', () => {
                chatMessagesView.classList.add('d-none');
                chatMessagesView.classList.remove('d-flex');
                chatListView.classList.remove('d-none');
            });
        }

        function cargarConversaciones() {
            fetch("{% url 'tienda:obtener_conversaciones' %}")
                .then(res => res.json())
                .then(data => {
                    const lista = document.getElementById('chat-list');
                    lista.innerHTML = '';
                    if (data.conversaciones.length === 0) {
                        lista.innerHTML = '<div class="p-3 text-center text-muted">No tienes mensajes</div>';
                        return;
                    }
                    data.conversaciones.forEach(c => {
                        lista.innerHTML += `
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="abrirConversacion(${c.id}, '${c.username}')">
                            <div>
                                <div class="fw-bold">${c.username}</div>
                                <small class="text-muted">${c.ultimo_mensaje || '...'}</small>
                            </div>
                            ${c.no_leidos > 0 ? `<span class="badge bg-danger rounded-pill">${c.no_leidos}</span>` : ''}
                        </button>
                    `;
                    });
                });
        }

        let usuarioActualId = null;

        function abrirConversacion(usuarioId, username) {
            usuarioActualId = usuarioId;
            document.getElementById('chat-user-name').textContent = username;

            chatListView.classList.add('d-none');
            chatMessagesView.classList.remove('d-none');
            chatMessagesView.classList.add('d-flex');

            cargarMensajes(usuarioId);
        }

        function cargarMensajes(usuarioId) {
            fetch(`/chat/mensajes/${usuarioId}/`)
                .then(res => res.json())
                .then(data => {
                    const contenedor = document.getElementById('chat-messages');
                    contenedor.innerHTML = '';
                    data.mensajes.forEach(msg => {
                        const esMio = msg.es_mio;
                        contenedor.innerHTML += `
                        <div class="d-flex ${esMio ? 'justify-content-end' : 'justify-content-start'}">
                            <div class="p-2 rounded ${esMio ? 'bg-success text-white' : 'bg-secondary text-white'}" style="max-width: 75%;">
                                ${msg.contenido}
                            </div>
                        </div>
                    `;
                    });
                    contenedor.scrollTop = contenedor.scrollHeight;
                });
        }

        document.getElementById('chat-send-btn')?.addEventListener('click', () => {
            const input = document.getElementById('chat-input');
            const contenido = input.value.trim();
            if (!contenido || !usuarioActualId) return;

            fetch("{% url 'tienda:enviar_mensaje' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ destinatario_id: usuarioActualId, contenido: contenido })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        input.value = '';
                        cargarMensajes(usuarioActualId);
                    }
                });
        });
    </script>

</body>

</html>
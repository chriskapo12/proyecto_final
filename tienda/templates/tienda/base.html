{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Tienda Online{% endblock %}</title>

    <!-- Fuente moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* üîß Reset y estructura */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Transiciones suaves al cambiar tema */
        body, header, footer, .producto-card, .producto-card a > div:last-child, .filter-panel > div { transition: background-color 0.18s ease, color 0.18s ease, box-shadow 0.18s ease; }

        /* Modo oscuro: se aplica a√±adiendo la clase .dark-mode al body */
        body.dark-mode {
            background-color: #000000;
            color: #ffffff;
        }
        /* Header y navegaci√≥n */
        body.dark-mode header { background: #0b1220; box-shadow: 0 2px 8px rgba(0,0,0,0.6); }
        body.dark-mode .nav-links a { color: #ffffff; }
        body.dark-mode .logo { color: #22c55e; }

        /* Footer y carrito */
        body.dark-mode footer { background: #0b1220; color: #ffffff; }
        body.dark-mode .carrito-contenido { background: #0f1724; color: #ffffff; }

        /* Texto del carrito */
        body.dark-mode .item-info h4 { color: #ffffff; }
        body.dark-mode .item-info p { color: #ffffff; }

    /* Tarjetas de producto (home, productos) */
    /* Mantener la caja exterior ligera y separar claramente la zona de imagen y la zona de info */
    body.dark-mode .producto-card { background: transparent; box-shadow: 0 8px 20px rgba(2,6,23,0.6); border-radius: 14px; overflow: hidden; }
    /* Zona de imagen: mantener fondo claro para que las im√°genes se vean n√≠tidas */
    body.dark-mode .producto-card a > div:first-child { background: #e5e7eb; }
    /* Zona de informaci√≥n: fondo oscuro y texto claro */
    body.dark-mode .producto-card a > div:last-child { background: #071226; color: #ffffff; }
    body.dark-mode .producto-card a > div:last-child .font-category, body.dark-mode .producto-card a > div:last-child .producto-nombre { color: #ffffff; }
    body.dark-mode .producto-card a > div:last-child .producto-nombre { color: #ffffff; font-weight:700; }
    body.dark-mode .producto-card .btn-agregar { background: #16a34a; color: white; box-shadow: 0 4px 10px rgba(2,6,23,0.5); }

    /* Panel de filtro */
    body.dark-mode .filter-panel > div { background: #ffffff; color: #0b1220; box-shadow: 0 4px 14px rgba(0,0,0,0.06); }
    /* Para el panel de filtro preferimos mantener los controles claros (mejor contraste con el fondo oscuro general) */
    body.dark-mode select, body.dark-mode input, body.dark-mode textarea { background: #f8fafc; color: #0b1220; border: 1px solid #e6edf3; }

        /* Tablas y listados */
        body.dark-mode table { color: #ffffff; }
        body.dark-mode table tr { border-color: rgba(255,255,255,0.04); }
        body.dark-mode th { background: rgba(255,255,255,0.02); color: #ffffff; }

        /* Botones principales: mantenemos verde pero con mayor contraste */
        body.dark-mode .btn-login, body.dark-mode .btn-logout { background: linear-gradient(135deg, #2ed573, #16a34a); }

        /* Inputs y formularios */
        body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { color: #94a3b8; }

        /* Otros ajustes generales */
        body.dark-mode .contador-carrito { background: #ef4444; }
        body.dark-mode .carrito { color: #22c55e; }
        body.dark-mode a { color: #60f089; }

        /* üîù Header fijo */
        header {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        nav {
            width: 100%; /* ocupar todo el ancho para permitir que el logo quede pegado a la izquierda y los enlaces a la derecha */
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        /* Buscador */
        .search-container {
            flex: 1;
            max-width: 500px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        .search-btn {
            background: #16a34a;
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            background: #15803d;
            transform: translateY(-2px);
        }

        body.dark-mode .search-input {
            background: #1a2332;
            color: #ffffff;
            border-color: #2d3e52;
        }

        body.dark-mode .search-input::placeholder {
            color: #94a3b8;
        }

        body.dark-mode .search-btn {
            background: #16a34a;
        }

        body.dark-mode .search-btn:hover {
            background: #15803d;
        }

        .logo {
            font-size: 1.7rem;
            font-weight: 700;
            color: #16a34a;
            text-decoration: none;
            margin-left: 0; /* asegurar que el logo quede pegado al borde izquierdo del nav */
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-right: 12px; /* separaci√≥n del borde derecho */
        }

        .nav-links a {
            color: #374151;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover { color: #16a34a; }

        /* Botones */
        .btn-login, .btn-logout {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 8px 18px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-login:hover, .btn-logout:hover {
            background: #15803d;
            transform: translateY(-2px);
        }

        /* üõí Carrito */
        .carrito {
            position: relative;
            font-size: 24px;
            color: #16a34a;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .carrito:hover { transform: scale(1.1); }

        .contador-carrito {
            position: absolute;
            top: -8px;
            right: -10px;
            background: #ef4444;
            color: white;
            font-size: 12px;
            padding: 3px 7px;
            border-radius: 50%;
            min-width: 20px;
            text-align: center;
        }

        /* üì¶ Contenido principal */
        main {
            flex: 1;
            padding: 40px 20px;
            max-width: 1200px;
            margin: auto;
            width: 100%;
        }

        /* ü¶∂ Footer */
        footer {
            background: #111827;
            color: #d1d5db;
            text-align: center;
            padding: 25px 0;
            font-size: 0.9rem;
            margin-top: 50px;
        }

        footer span { color: #22c55e; font-weight: 600; }

        /* üß© Panel lateral del carrito */
        /* Aumentar z-index para asegurarnos que el carrito quede por encima de paneles como el filtro */
        .carrito-overlay {
            position: fixed;
            top: 0; right: 0;
            width: 0;
            height: 100%;
            background: rgba(0,0,0,0.4);
            overflow: hidden;
            transition: width 0.4s ease;
            z-index: 12000; /* mayor que .filter-panel (1100) */
        }

        .carrito-contenido {
            position: absolute;
            top: 0; right: 0;
            width: 400px;
            max-width: 90%;
            height: 100%;
            background: #fff;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.4s ease;
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 12001; /* asegurar que el contenido del carrito est√© arriba */
        }

        .carrito-overlay.activo { width: 100%; }
        .carrito-overlay.activo .carrito-contenido { transform: translateX(0); }

        .carrito-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }

    .carrito-header h3 { color: #111827; font-weight: 600; }

        .cerrar-carrito {
            cursor: pointer;
            color: #ef4444;
            font-size: 22px;
            font-weight: bold;
            transition: transform 0.3s;
        }
        .cerrar-carrito:hover { transform: rotate(90deg); }

        .carrito-items {
            flex: 1;
            overflow-y: auto;
            margin-top: 15px;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e5e7eb;
            padding: 10px 0;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .item-info { flex: 1; }

    .item-info h4 { font-size: 15px; color: #111827; }
    .item-info p { font-size: 13px; color: #6b7280; }

        .controles-cantidad {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .controles-cantidad button {
            background: #16a34a;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 5px;
            cursor: pointer;
        }

        .controles-cantidad span {
            min-width: 20px;
            text-align: center;
            display: inline-block;
        }

        .carrito-footer {
            border-top: 1px solid #e5e7eb;
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        @media (max-width: 700px) {
            .carrito-contenido { width: 100%; }
        }

        /* üí¨ Chat */
        .chat-btn {
            position: relative;
            font-size: 22px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .chat-btn:hover { transform: scale(1.15); }

        .chat-badge {
            position: absolute;
            top: -8px;
            right: -10px;
            background: #ef4444;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 50%;
            min-width: 18px;
            text-align: center;
            font-weight: bold;
        }

        /* Panel de chat flotante */
        .chat-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 600px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 11999;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .chat-panel.activo { display: flex; }

        .chat-header {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
        }

        .chat-header-title {
            flex: 1;
            margin-left: 10px;
        }

        .cerrar-chat {
            cursor: pointer;
            font-size: 20px;
            transition: transform 0.3s;
        }

        .cerrar-chat:hover { transform: rotate(90deg); }

        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-lista {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chat-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-item:hover { background: #f9fafb; }

        .chat-item-user {
            font-weight: 500;
            color: #111827;
        }

        .chat-item-badge {
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 50%;
            min-width: 16px;
            text-align: center;
        }

        .chat-vacio {
            color: #9ca3b8;
            text-align: center;
            padding: 30px 10px;
            font-size: 0.9rem;
        }

        /* Ventana de mensajes */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mensaje {
            display: flex;
            margin-bottom: 8px;
            animation: fadeIn 0.2s ease;
        }

        .mensaje.propio {
            justify-content: flex-end;
        }

        .mensaje-contenido {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 12px;
            word-wrap: break-word;
            font-size: 0.9rem;
        }

        .mensaje-propio .mensaje-contenido {
            background: #16a34a;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .mensaje-otro .mensaje-contenido {
            background: #f0f0f0;
            color: #111827;
            border-bottom-left-radius: 4px;
        }

        .chat-input-area {
            border-top: 1px solid #e5e7eb;
            padding: 12px;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            resize: none;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.1);
        }

        .chat-send-btn {
            background: #16a34a;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            background: #15803d;
            transform: translateY(-2px);
        }

        /* Dark mode para chat */
        body.dark-mode .chat-panel {
            background: #0f1724;
            color: #ffffff;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
        }

        body.dark-mode .chat-content {
            background: #0f1724;
        }

        body.dark-mode .chat-item {
            border-bottom-color: #1a2332;
            color: #ffffff;
        }

        body.dark-mode .chat-item:hover { background: #1a2332; }

        body.dark-mode .chat-item-user { color: #ffffff; }

        body.dark-mode .chat-messages {
            background: #0f1724;
        }

        body.dark-mode .mensaje-otro .mensaje-contenido {
            background: #1a2332;
            color: #ffffff;
        }

        body.dark-mode .chat-input {
            background: #1a2332;
            color: #ffffff;
            border-color: #2d3e52;
        }

        body.dark-mode .chat-input::placeholder {
            color: #94a3b8;
        }

        body.dark-mode .chat-input-area {
            border-top-color: #1a2332;
            background: #0f1724;
        }
    </style>
</head>
<body>

<header>
    <nav>
    <a href="{% url 'tienda:home' %}" class="logo"><3 Bebidas Oeste</a>
        
        <!-- Buscador central -->
        <div class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="Buscar productos..." autocomplete="off">
            <button type="button" id="search-btn" class="search-btn" title="Buscar">üîç</button>
        </div>

        <div class="nav-links">
            <a href="{% url 'tienda:productos' %}">Productos</a>
            <!-- Toggle de tema claro/oscuro -->
            <button id="theme-toggle" aria-label="Alternar tema" title="Alternar tema" style="background:transparent;border:none;cursor:pointer;font-size:18px;color:inherit;padding:6px;">
                üåô
            </button>

            {% if user.is_authenticated %}
                <!-- ÔøΩ Chat -->
                <div class="chat-btn" id="abrir-chat" title="Mensajes">
                    üí¨
                    <span id="chat-badge" class="chat-badge" style="display:none;">0</span>
                </div>

                <!-- ÔøΩüõí Carrito √∫nico y funcional -->
                <div class="carrito" id="abrir-carrito" title="Ver carrito">
                    üõí
                    <span id="contador-carrito" class="contador-carrito">
                        {{ user.carrito.total_items|default:0 }}
                    </span>
                </div>

                <a href="{% url 'tienda:logout' %}" class="btn-logout">Cerrar sesi√≥n</a>
            {% else %}
                <a href="{% url 'tienda:login' %}" class="btn-login">Iniciar sesi√≥n</a>
                <a href="{% url 'tienda:register' %}" class="btn-login" style="background:#2563eb;">Registrarse</a>
            {% endif %}
        </div>
    </nav>
</header>

<main>
    {% block content %}{% endblock %}
</main>

<!-- üõç Panel lateral del carrito -->
<div class="carrito-overlay" id="carrito-overlay">
    <div class="carrito-contenido">
        <div class="carrito-header">
            <h3>üõí Tu carrito</h3>
            <span class="cerrar-carrito" id="cerrar-carrito">√ó</span>
        </div>

        <div class="carrito-items" id="carrito-items">
            <p style="color:#6b7280;">Tu carrito est√° vac√≠o</p>
        </div>

        <div class="carrito-footer" style="flex-direction:column; gap:15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <span style="font-size:1.1rem;">Total:</span> 
                <span id="total-carrito" style="font-size:1.2rem; color:#16a34a; font-weight:bold;">$0.00</span>
            </div>
            <a href="{% url 'tienda:procesar_pago' %}" id="btn-pagar" 
                    style="width:100%; background:linear-gradient(135deg, #22c55e, #16a34a); color:white; 
                           text-decoration: none; padding:15px; border-radius:12px; font-size:1.1em;
                           cursor:pointer; font-weight:600; display:flex; justify-content:center; 
                           align-items:center; gap:12px; transition:all 0.3s ease; 
                           box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                <span style="font-size:1.2em;">üí≥</span>
                Pagar ahora
            </a>
        </div>
    </div>
</div>

<footer>
    <p>¬© 2025 <span>Bebidas Oeste</span>. Todos los derechos reservados.</p>
</footer>

<!-- üí¨ Panel de chat flotante -->
<div class="chat-panel" id="chat-panel">
    <div class="chat-header">
        <span class="chat-header-title">Mensajes</span>
        <span class="cerrar-chat" id="cerrar-chat">√ó</span>
    </div>
    
    <!-- Lista de conversaciones -->
    <div class="chat-content" id="chat-list-view">
        <ul class="chat-lista" id="chat-list">
            <li class="chat-vacio">No tienes mensajes</li>
        </ul>
    </div>
    
    <!-- Vista de conversaci√≥n individual -->
    <div class="chat-content" id="chat-messages-view" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #e5e7eb;">
            <button id="volver-chat" style="background:none; border:none; cursor:pointer; color:#16a34a; font-size:18px;">‚Üê Volver</button>
            <span id="chat-user-name" style="font-weight:600; color:#111827;"></span>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-area">
            <textarea class="chat-input" id="chat-input" placeholder="Escribe un mensaje..." rows="1"></textarea>
            <button class="chat-send-btn" id="chat-send-btn">Enviar</button>
        </div>
    </div>
</div>

<!-- ‚öôÔ∏è Script funcional -->
<script>
    const abrir = document.getElementById('abrir-carrito');
    const cerrar = document.getElementById('cerrar-carrito');
    const overlay = document.getElementById('carrito-overlay');
    const contenedorItems = document.getElementById('carrito-items');
    const totalCarrito = document.getElementById('total-carrito');
    const contadorCarrito = document.getElementById('contador-carrito');

    // Abrir carrito
    abrir?.addEventListener('click', () => {
        overlay.classList.add('activo');
        cargarCarrito();
    });

    // Cerrar carrito
    cerrar?.addEventListener('click', () => overlay.classList.remove('activo'));
    overlay?.addEventListener('click', e => {
        if (e.target === overlay) overlay.classList.remove('activo');
    });

    // Cargar carrito desde Django
    function cargarCarrito() {
        fetch("{% url 'tienda:obtener_carrito_ajax' %}")
            .then(res => res.json())
            .then(data => {
                contenedorItems.innerHTML = "";
                if (!data.items || data.items.length === 0) {
                    contenedorItems.innerHTML = "<p style='color:#6b7280;'>Tu carrito est√° vac√≠o</p>";
                } else {
                    data.items.forEach(item => {
                        const div = document.createElement("div");
                        div.classList.add("item");
                        div.innerHTML = `
                            <img src="${item.imagen || '{% static "img/placeholder.png" %}'}" alt="">
                            <div class="item-info">
                                <h4>${item.nombre}</h4>
                                <p>Precio unitario: $${item.precio.toFixed(2)}</p>
                                <div class="controles-cantidad">
                                    <button class="btn-restar" data-producto-id="${item.producto_id}">-</button>
                                    <span class="cantidad">${item.cantidad}</span>
                                    <button class="btn-sumar" data-producto-id="${item.producto_id}">+</button>
                                </div>
                                <strong>Subtotal: $${item.subtotal.toFixed(2)}</strong>
                                <button class="btn-eliminar" data-producto-id="${item.producto_id}"
                                    style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-top:5px;">
                                    üóë Eliminar
                                </button>
                            </div>
                        `;
                        contenedorItems.appendChild(div);
                    });

                    // Eventos para botones (usamos data-producto-id)
                    document.querySelectorAll('.btn-eliminar').forEach(btn => {
                        btn.addEventListener('click', () => eliminarDelCarrito(btn.dataset.productoId));
                    });
                    document.querySelectorAll('.btn-sumar').forEach(btn => {
                        btn.addEventListener('click', () => actualizarCantidad(btn.dataset.productoId, 'sumar'));
                    });
                    document.querySelectorAll('.btn-restar').forEach(btn => {
                        btn.addEventListener('click', () => actualizarCantidad(btn.dataset.productoId, 'restar'));
                    });
                }

                totalCarrito.textContent = `$${data.total.toFixed(2)}`;
                contadorCarrito.textContent = data.total_items;

                // Actualizar estado del enlace de pago
                const btnPagar = document.getElementById('btn-pagar');
                if (data.items && data.items.length > 0) {
                    btnPagar.style.opacity = '1';
                    btnPagar.style.pointerEvents = 'all';
                    btnPagar.style.cursor = 'pointer';
                    btnPagar.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                    btnPagar.href = "{% url 'tienda:procesar_pago' %}";
                    btnPagar.onmouseover = () => {
                        btnPagar.style.transform = 'translateY(-2px)';
                        btnPagar.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
                        btnPagar.style.background = 'linear-gradient(135deg, #2ed573, #15803d)';
                    };
                    btnPagar.onmouseout = () => {
                        btnPagar.style.transform = '';
                        btnPagar.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                        btnPagar.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                    };
                } else {
                    btnPagar.style.opacity = '0.5';
                    btnPagar.style.pointerEvents = 'none';
                    btnPagar.style.cursor = 'not-allowed';
                    btnPagar.href = '#';
                    btnPagar.style.background = '#9ca3af';
                    btnPagar.onmouseover = null;
                    btnPagar.onmouseout = null;
                    btnPagar.style.transform = '';
                    btnPagar.style.boxShadow = 'none';
                }
            })
            .catch(err => console.error("Error al obtener carrito:", err));
    }

                    // helper para leer cookie CSRF
                    function getCookie(name) {
                        let cookieValue = null;
                        if (document.cookie && document.cookie !== '') {
                            const cookies = document.cookie.split(';');
                            for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }

                    // Eliminar producto
                    function eliminarDelCarrito(productoId) {
                        fetch(`/carrito/eliminar/${productoId}/`, {
                            method: 'GET',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                cargarCarrito();
                                contadorCarrito.textContent = data.total_items;
                            }
                        })
                        .catch(err => console.error("Error al eliminar del carrito:", err));
                    }

                    // Actualizar cantidad
                    function actualizarCantidad(productoId, accion) {
                        fetch("{% url 'tienda:actualizar_cantidad' %}", {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({ producto_id: productoId, accion: accion })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) return console.error(data.error);

                            const itemDiv = document.querySelector(`.btn-sumar[data-producto-id='${productoId}']`).closest('.item');
                            itemDiv.querySelector('.cantidad').textContent = data.cantidad;
                            itemDiv.querySelector('strong').textContent = `Subtotal: $${data.subtotal.toFixed(2)}`;

                            totalCarrito.textContent = `$${data.total.toFixed(2)}`;
                            contadorCarrito.textContent = data.total_items;
                        })
                        .catch(err => console.error("Error al actualizar cantidad:", err));
                    }

                    // Tema claro/oscuro: persistir en localStorage
                    const themeToggle = document.getElementById('theme-toggle');
                    function applyTheme(theme) {
                        if (theme === 'dark') {
                            document.body.classList.add('dark-mode');
                            if (themeToggle) themeToggle.textContent = '‚òÄÔ∏è';
                        } else {
                            document.body.classList.remove('dark-mode');
                            if (themeToggle) themeToggle.textContent = 'üåô';
                        }
                    }
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    applyTheme(savedTheme);
                    themeToggle?.addEventListener('click', () => {
                        const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
                        localStorage.setItem('theme', next);
                        applyTheme(next);
                    });

                    // ‚öôÔ∏è Funcionalidad de b√∫squeda
                    const searchInput = document.getElementById('search-input');
                    const searchBtn = document.getElementById('search-btn');
                    
                    function performSearch() {
                        const query = searchInput.value.trim();
                        if (query) {
                            // Redirigir a la p√°gina de b√∫squeda
                            window.location.href = `/productos/?buscar=${encodeURIComponent(query)}`;
                        }
                    }
                    
                    // B√∫squeda con click en bot√≥n
                    searchBtn?.addEventListener('click', performSearch);
                    
                    // B√∫squeda al presionar Enter
                    searchInput?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            performSearch();
                        }
                    });

                    // üí¨ Funcionalidad de Chat
                    const chatBtn = document.getElementById('abrir-chat');
                    const chatPanel = document.getElementById('chat-panel');
                    const cerrarChat = document.getElementById('cerrar-chat');
                    const chatListView = document.getElementById('chat-list-view');
                    const chatMessagesView = document.getElementById('chat-messages-view');
                    const volverChat = document.getElementById('volver-chat');
                    const chatList = document.getElementById('chat-list');
                    const chatMessages = document.getElementById('chat-messages');
                    const chatInput = document.getElementById('chat-input');
                    const chatSendBtn = document.getElementById('chat-send-btn');
                    const chatUserName = document.getElementById('chat-user-name');
                    const chatBadge = document.getElementById('chat-badge');

                    let usuarioActualChat = null;
                    let pollInterval = null;

                    function abrirChat() {
                        chatPanel.classList.add('activo');
                        // Cargar inmediatamente al abrir
                        cargarConversaciones();
                        // Limpiar intervalo anterior si existe
                        if (pollInterval) clearInterval(pollInterval);
                        // Configurar polling cada 2 segundos para ser m√°s responsivo
                        pollInterval = setInterval(() => {
                            cargarConversaciones();
                            // Si hay un usuario activo en chat, tambi√©n actualizar sus mensajes
                            if (usuarioActualChat) {
                                cargarMensajes(usuarioActualChat);
                            }
                        }, 2000);
                    }

                    function cerrarChatPanel() {
                        chatPanel.classList.remove('activo');
                        if (pollInterval) clearInterval(pollInterval);
                    }

                    chatBtn?.addEventListener('click', abrirChat);
                    cerrarChat?.addEventListener('click', cerrarChatPanel);

                    function cargarConversaciones() {
                        fetch('/chat/conversaciones/')
                            .then(res => res.json())
                            .then(data => {
                                chatList.innerHTML = '';
                                if (data.conversaciones.length === 0) {
                                    chatList.innerHTML = '<li class="chat-vacio">No tienes mensajes</li>';
                                } else {
                                    let totalNoLeidos = 0;
                                    data.conversaciones.forEach(conv => {
                                        totalNoLeidos += conv.no_leidos;
                                        const li = document.createElement('li');
                                        li.className = 'chat-item';
                                        li.innerHTML = `
                                            <div>
                                                <div class="chat-item-user">@${conv.username}</div>
                                                <small style="color:#6b7280;">${conv.ultimo_mensaje}</small>
                                            </div>
                                            ${conv.no_leidos > 0 ? `<div class="chat-item-badge">${conv.no_leidos}</div>` : ''}
                                        `;
                                        li.addEventListener('click', () => abrirConversacion(conv.id, conv.username));
                                        chatList.appendChild(li);
                                    });
                                    // Actualizar badge de chat
                                    if (totalNoLeidos > 0) {
                                        chatBadge.textContent = totalNoLeidos;
                                        chatBadge.style.display = 'block';
                                    } else {
                                        chatBadge.style.display = 'none';
                                    }
                                }
                            })
                            .catch(err => console.error('Error cargando conversaciones:', err));
                    }

                    function abrirConversacion(usuarioId, username) {
                        usuarioActualChat = usuarioId;
                        chatListView.style.display = 'none';
                        chatMessagesView.style.display = 'flex';
                        chatUserName.textContent = '@' + username;
                        cargarMensajes(usuarioId);
                    }

                    // Hacer la funci√≥n global para que otros scripts la puedan llamar
                    window.abrirConversacion = abrirConversacion;

                    function cargarMensajes(usuarioId) {
                        fetch(`/chat/mensajes/${usuarioId}/`)
                            .then(res => res.json())
                            .then(data => {
                                try {
                                    // Determinar si el usuario estaba pegado al final
                                    const atBottom = (chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight) < 50;

                                    // Obtener √∫ltimo id existente para solo a√±adir nuevos mensajes
                                    const lastEl = chatMessages.lastElementChild;
                                    const existingLastId = lastEl && lastEl.dataset && lastEl.dataset.msgId ? Number(lastEl.dataset.msgId) : null;

                                    if (!existingLastId) {
                                        // Primera carga o vista vac√≠a: limpiar y renderizar todo
                                        chatMessages.innerHTML = '';
                                        data.mensajes.forEach(msg => {
                                            const div = document.createElement('div');
                                            div.className = 'mensaje ' + (msg.es_mio ? 'propio' : 'otro');
                                            div.dataset.msgId = msg.id;
                                            div.innerHTML = `<div class="mensaje-contenido">${msg.contenido}</div>`;
                                            chatMessages.appendChild(div);
                                        });
                                        // Siempre llevar al final en la primera carga
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                    } else {
                                        // A√±adir solo mensajes nuevos (id mayor que existingLastId)
                                        let added = 0;
                                        data.mensajes.forEach(msg => {
                                            if (msg.id <= existingLastId) return; // ya renderizado
                                            const div = document.createElement('div');
                                            div.className = 'mensaje ' + (msg.es_mio ? 'propio' : 'otro');
                                            div.dataset.msgId = msg.id;
                                            div.innerHTML = `<div class="mensaje-contenido">${msg.contenido}</div>`;
                                            chatMessages.appendChild(div);
                                            added += 1;
                                        });

                                        // Si el usuario estaba al final, desplazarse hacia abajo solo si se agregaron mensajes
                                        if (atBottom && added > 0) {
                                            chatMessages.scrollTop = chatMessages.scrollHeight;
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error procesando mensajes:', e);
                                }
                            })
                            .catch(err => console.error('Error cargando mensajes:', err));
                    }

                    volverChat?.addEventListener('click', () => {
                        usuarioActualChat = null;
                        chatListView.style.display = 'block';
                        chatMessagesView.style.display = 'none';
                        cargarConversaciones(); // Recargar conversaciones al volver
                    });

                    chatSendBtn?.addEventListener('click', enviarMensaje);
                    chatInput?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            enviarMensaje();
                        }
                    });

                    function enviarMensaje() {
                        const contenido = chatInput.value.trim();
                        if (!contenido || !usuarioActualChat) return;

                        fetch('/chat/enviar/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken'),
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                destinatario_id: usuarioActualChat,
                                contenido: contenido
                            })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                chatInput.value = '';
                                chatInput.style.height = 'auto'; // Resetear altura del textarea
                                cargarMensajes(usuarioActualChat);
                                // Recargar conversaciones para que aparezca el nuevo mensaje
                                cargarConversaciones();
                                console.log('Mensaje enviado y conversaciones recargadas');
                            } else {
                                console.error('Error al enviar mensaje:', data.error);
                            }
                        })
                        .catch(err => console.error('Error enviando mensaje:', err));
                    }

</script>




</body>
</html>
